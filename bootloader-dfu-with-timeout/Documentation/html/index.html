<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.4"/>
<title>LUFA Library - DFU Class Bootloader: DFU Class USB AVR Bootloader</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">LUFA Library - DFU Class Bootloader
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.4 -->
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('index.html','');});
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">DFU Class USB AVR Bootloader </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="Sec_Compat"></a>
Demo Compatibility:</h1>
<p>The following list indicates what microcontrollers are compatible with this demo.</p>
<ul>
<li>Series 7 USB AVRs (AT90USBxxx7) </li>
<li>Series 6 USB AVRs (AT90USBxxx6) </li>
<li>Series 4 USB AVRs (ATMEGAxxU4) - <em>See <a class="el" href="index.html#SSec_Aux_Space">Auxiliary Bootloader Section</a></em> </li>
<li>Series 2 USB AVRs (AT90USBxx2, ATMEGAxxU2) - <em>See <a class="el" href="index.html#SSec_Aux_Space">Auxiliary Bootloader Section</a></em></li>
</ul>
<h1><a class="anchor" id="Sec_Info"></a>
USB Information:</h1>
<p>The following table gives a rundown of the USB utilization of this demo.</p>
<table class="doxtable">
<tr>
<td><b>USB Mode:</b> </td><td>Device  </td></tr>
<tr>
<td><b>USB Class:</b> </td><td>Device Firmware Update Class (DFU)  </td></tr>
<tr>
<td><b>USB Subclass:</b> </td><td>None  </td></tr>
<tr>
<td><b>Relevant Standards:</b> </td><td>USBIF DFU Class Standard, Atmel USB Bootloader Datasheet  </td></tr>
<tr>
<td><b>Supported USB Speeds:</b> </td><td>Low Speed Mode <br/>
 Full Speed Mode  </td></tr>
</table>
<h1><a class="anchor" id="Sec_Description"></a>
Project Description:</h1>
<p>This bootloader enumerates to the host as a DFU Class device, allowing for DFU-compatible programming software to load firmware onto the AVR.</p>
<p>Out of the box this bootloader builds for the AT90USB1287 with an 8KB bootloader section size, and will fit into 4KB of bootloader space. If you wish to alter this size and/or change the AVR model, you will need to edit the MCU, FLASH_SIZE_KB and BOOT_SECTION_SIZE_KB values in the accompanying makefile.</p>
<p>When the bootloader is running, the board's LED(s) will flash at regular intervals to distinguish the bootloader from the normal user application.</p>
<h1><a class="anchor" id="Sec_Installation"></a>
Driver Installation</h1>
<p>This bootloader is designed to be compatible with Atmel's provided Windows DFU class drivers. You will need to install Atmel's DFU drivers prior to using this bootloader on Windows platforms. If you are using a 64 bit Windows OS, you will need to either disable the driver signing requirement (see online tutorials for details) or use a digitally signed version of the official Atmel driver provided by a third party AVR user at <a href="http://www.avrfreaks.net/index.php?module=Freaks%20Academy&func=viewItem&item_id=2196&item_type=project">http://www.avrfreaks.net/index.php?module=Freaks%20Academy&amp;func=viewItem&amp;item_id=2196&amp;item_type=project</a>.</p>
<dl class="section note"><dt>Note</dt><dd>This device spoofs Atmel's DFU Bootloader USB VID and PID so that the Atmel DFU bootloader drivers included with FLIP will work. If you do not wish to use Atmel's ID codes, please manually change them in <a class="el" href="a00011.html">Descriptors.c</a> and alter your driver's INF file accordingly.</dd></dl>
<h1><a class="anchor" id="Sec_HostApp"></a>
Host Controller Application</h1>
<p>This bootloader is compatible with Atmel's FLIP utility on Windows machines, and dfu-programmer on Linux machines.</p>
<h2><a class="anchor" id="SSec_FLIP"></a>
FLIP (Windows)</h2>
<p>FLIP (Flexible In-System Programmer) is a utility written by Atmel, and distributed for free on the Atmel website. The FLIP utility is designed to assist in the bootloader programming of a range of Atmel devices, through several popular physical interfaces including USB. It is written in Java, however makes use of native extensions for USB support and thus is only offered on Windows.</p>
<p>To program a device using FLIP, refer to the Atmel FLIP documentation.</p>
<h2><a class="anchor" id="SSec_DFUProgrammer"></a>
dfu-programmer (Linux)</h2>
<p>dfu-programmer is an open-source command line solution for the bootloader programming of Atmel devices through a USB connection, using the DFU protocol, available for download at <a href="http://sourceforge.net/projects/dfu-programmer/">http://sourceforge.net/projects/dfu-programmer/</a>.</p>
<p>The following example loads a HEX file into the AVR's FLASH memory using dfu-programmer: </p>
<div class="fragment"><div class="line">dfu-programmer at90usb1287 erase flash Mouse.hex</div>
</div><!-- fragment --><h1><a class="anchor" id="Sec_API"></a>
User Application API</h1>
<p>Several user application functions for FLASH and other special memory area manipulations are exposed by the bootloader, allowing the user application to call into the bootloader at runtime to read and write FLASH data.</p>
<dl class="section warning"><dt>Warning</dt><dd>The APIs exposed by the DFU class bootloader are <b>NOT</b> compatible with the API exposed by the official Atmel DFU bootloader.</dd></dl>
<p>By default, the bootloader API jump table is located 32 bytes from the end of the device's FLASH memory, and follows the following layout:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#define BOOTLOADER_API_TABLE_SIZE          32</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define BOOTLOADER_API_TABLE_START         ((FLASHEND + 1UL) - BOOTLOADER_API_TABLE_SIZE)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define BOOTLOADER_API_CALL(Index)         (void*)((BOOTLOADER_API_TABLE_START + (Index * 2)) / 2)</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">void    (*<a class="code" href="a00004.html#a24b83742d50698da694228c7e22430ad">BootloaderAPI_ErasePage</a>)(uint32_t Address)               = BOOTLOADER_API_CALL(0);</div>
<div class="line">void    (*<a class="code" href="a00004.html#a658514e1b5e6ea2ce0961f6f7e02dffb">BootloaderAPI_WritePage</a>)(uint32_t Address)               = BOOTLOADER_API_CALL(1);</div>
<div class="line">void    (*<a class="code" href="a00004.html#a56546f3c50d0a6df07c807034abaa9c6">BootloaderAPI_FillWord</a>)(uint32_t Address, uint16_t Word) = BOOTLOADER_API_CALL(2);</div>
<div class="line">uint8_t (*<a class="code" href="a00004.html#a5438f1b6859128f5e49e7e48ac2edd5d">BootloaderAPI_ReadSignature</a>)(uint16_t Address)           = BOOTLOADER_API_CALL(3);</div>
<div class="line">uint8_t (*<a class="code" href="a00004.html#a75fda26274bb7f8eb5ab4ec7f18480a6">BootloaderAPI_ReadFuse</a>)(uint16_t Address)                = BOOTLOADER_API_CALL(4);</div>
<div class="line">uint8_t (*<a class="code" href="a00004.html#a1d07523558f9d43e46b4d7c7aead42bd">BootloaderAPI_ReadLock</a>)(void)                            = BOOTLOADER_API_CALL(5);</div>
<div class="line">void    (*<a class="code" href="a00004.html#a7bbe71ef5d5ca96c3beee81c76ac427a">BootloaderAPI_WriteLock</a>)(uint8_t LockBits)               = BOOTLOADER_API_CALL(6);</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define BOOTLOADER_MAGIC_SIGNATURE_START   (BOOTLOADER_API_TABLE_START + (BOOTLOADER_API_TABLE_SIZE - 2))</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define BOOTLOADER_MAGIC_SIGNATURE         0xDCFB</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define BOOTLOADER_CLASS_SIGNATURE_START   (BOOTLOADER_API_TABLE_START + (BOOTLOADER_API_TABLE_SIZE - 4))</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define BOOTLOADER_DFU_SIGNATURE           0xDF10</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define BOOTLOADER_ADDRESS_START           (BOOTLOADER_API_TABLE_START + (BOOTLOADER_API_TABLE_SIZE - 8))</span></div>
<div class="line"><span class="preprocessor">#define BOOTLOADER_ADDRESS_LENGTH          4</span></div>
</div><!-- fragment --><p>From the application the API support of the bootloader can be detected by reading the FLASH memory bytes located at address <code>BOOTLOADER_MAGIC_SIGNATURE_START</code> and comparing them to the value <code>BOOTLOADER_MAGIC_SIGNATURE</code>. The class of bootloader can be determined by reading the FLASH memory bytes located at address <code>BOOTLOADER_CLASS_SIGNATURE_START</code> and comparing them to the value <code>BOOTLOADER_DFU_SIGNATURE</code>. The start address of the bootloader can be retrieved by reading the bytes of FLASH memory starting from address <code>BOOTLOADER_ADDRESS_START</code>.</p>
<h2><a class="anchor" id="SSec_API_MemLayout"></a>
Device Memory Map</h2>
<p>The following illustration indicates the final memory map of the device when loaded with the bootloader.</p>
<pre class="fragment">*  +----------------------------+ 0x0000
*  |                            |
*  |                            |
*  |                            |
*  |                            |
*  |                            |
*  |                            |
*  |                            |
*  |                            |
*  |      User Application      |
*  |                            |
*  |                            |
*  |                            |
*  |                            |
*  |                            |
*  |                            |
*  |                            |
*  |                            |
*  +----------------------------+ FLASHEND - BOOT_AUX_SECTION_SIZE
*  | Booloader Start Trampoline |
*  | (Not User App. Accessible) |
*  +----------------------------+ FLASHEND - (BOOT_AUX_SECTION_SIZE - 4)
*  |                            |
*  |     Auxillery Bootloader   |
*  |  Space for Smaller Devices |
*  | (Not User App. Accessible) |
*  |                            |
*  +----------------------------+ FLASHEND - BOOT_SECTION_SIZE
*  |                            |
*  |   Bootloader Application   |
*  | (Not User App. Accessible) |
*  |                            |
*  +----------------------------+ FLASHEND - 96
*  |   API Table Trampolines    |
*  | (Not User App. Accessible) |
*  +----------------------------+ FLASHEND - 32
*  |    Bootloader API Table    |
*  |   (User App. Accessible)   |
*  +----------------------------+ FLASHEND - 8
*  |   Bootloader ID Constants  |
*  |   (User App. Accessible)   |
*  +----------------------------+ FLASHEND
*  </pre><h2><a class="anchor" id="SSec_Aux_Space"></a>
Auxiliary Bootloader Section</h2>
<p>To make the bootloader function on smaller devices (those with a physical bootloader section of smaller than 6KB)</p>
<h1><a class="anchor" id="Sec_KnownIssues"></a>
Known Issues:</h1>
<dl class="section user"><dt>On Linux machines, the DFU bootloader is inaccessible.</dt><dd>On many Linux systems, non-root users do not have automatic access to newly inserted DFU devices. Root privileges or a UDEV rule is required to gain access. See <a href="https://groups.google.com/d/msg/lufa-support/CP9cy2bc8yo/kBqsOu-RBeMJ">here</a> for resolution steps.</dd></dl>
<dl class="section user"><dt>After loading an application, it is not run automatically on startup.</dt><dd>Some USB AVR boards ship with the BOOTRST fuse set, causing the bootloader to run automatically when the device is reset. In most cases, the BOOTRST fuse should be disabled and the HWBE fuse used instead to run the bootloader when needed.</dd></dl>
<h1><a class="anchor" id="Sec_Options"></a>
Project Options</h1>
<p>The following defines can be found in this demo, which can control the demo behaviour when defined, or changed in value.</p>
<table class="doxtable">
<tr>
<th><b>Define Name:</b> </th><th><b>Location:</b> </th><th><b>Description:</b>  </th></tr>
<tr>
<td>SECURE_MODE </td><td><a class="el" href="a00009.html" title="Application Configuration Header File. ">AppConfig.h</a> </td><td>If defined to <code>true</code>, the bootloader will not accept any memory commands other than a chip erase on start-up, until an erase has been performed. This can be used in conjunction with the AVR's lockbits to prevent the AVRs firmware from being dumped by unauthorized persons. When false, all memory operations are allowed at any time.  </td></tr>
</table>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.4 </li>
  </ul>
</div>
</body>
</html>
